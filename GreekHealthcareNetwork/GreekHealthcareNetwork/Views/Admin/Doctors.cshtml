@{
    ViewBag.Title = "Doctors";
}
@section cssScripts{
    <link href="@Url.Content("~/Content/TestPlaton.css")" type="text/css" rel="stylesheet" />
    <style> 
        body {
            width: 146vw;   
        }    
    </style>
}

<main id="main" class="offset-2 mt-5">
    <div class="page-header">
        <h1>
            Doctors
        </h1>
    </div>
    <div class="">
        <table class="table mt-4" id="doctorsList">
            <thead>
                <tr>
                    <th scope="col"></th>
                    <th scope="col">First Name</th>
                    <th scope="col">Last Name</th>
                    <th scope="col">Specialty</th>
                    <th scope="col">Address</th>
                    <th scope="col">AMKA</th>
                    <th scope="col">Telephone</th>
                    <th scope="col">Paypal Account</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</main>


@section scripts{
    @Scripts.Render("~/bundles/jqueryval")
    <script>


    $(document).ready(function () {
        ListDoctors('', '', -1);
        var counter = 0;
        function ListDoctors(firstName, lastName, specialty) {
            $.ajax({
                dataType: 'json',
                type: 'get',
                url: '/api/Search/AdminSearchDoctorResults?doctorsFirstName=' + firstName + '&doctorsLastName=' + lastName + '&doctorsSpecialty=' + specialty + '&appointmentDate=0001-01-01',
                success: function (data) {
                    console.log(data);
                    console.log(data.length);
                    $('#doctorsList tbody').empty();
                    data.forEach(function (doctor) {
                        console.log('counter= ' + ++counter);
                        $('#doctorsList tbody').append(
                              '<tr><td><img src="@Url.Content("~/Content/img/Doctors/")' + doctor.User.Id + '/' + doctor.User.ProfilePicture + '" alt="' + doctor.User.ProfilePicture + '"' + 'class="rounded-circle">'
                            + '</td><td>' + doctor.User.FirstName
                            + '</td><td>' + doctor.User.LastName
                            + '</td><td>' + doctor.MedicalSpecialty
                            + '</td><td>' + doctor.OfficeAddress
                            + '</td><td>' + doctor.User.AMKA
                            + '</td><td>' + doctor.User.PhoneNumber
                            + '</td><td>' + doctor.User.PaypalAccount
                            + '</td>'                           
                            + '<td><button class="btn btn-success table-button editBtn" data-id="' + doctor.UserId + '" >Edit</button>'
                            + ((doctor.User.IsActive == true) ? '<button class="btn btn-danger table-button setActiveBtn" data-is-active="true" data-id="' + doctor.UserId + '">Deactivate</button>' : '<button class="btn btn-danger table-button setActiveBtn" data-is-active="false" data-id="' + doctor.UserId + '">Activate</button>')
                            + '<button class="btn btn-primary table-button sentMessageBtn" data-id="' + doctor.UserId + '" >Message</button>'
                            + '<a class="btn btn-secondary table-button payBtn" href="https://www.sandbox.paypal.com/myaccount/transfer/homepage" target="_blank" data-id="' + doctor.UserId + '" >Pay</a>'
                            + '</tr>')
                    });
                    $('.editBtn').on('click', function (e) {
                        var grandParent = $(this).parent().parent();
                        grandParent.append('<form id="__AjaxAntiForgeryForm" action="#" method="post">@Html.AntiForgeryToken()</form>');
                        var firstName = grandParent.children('td:nth-child(2)').html();
                        grandParent.children('td:nth-child(2)').html("");
                        grandParent.children('td:nth-child(2)').append('<input type="text" class="form-control col-6" value="' + firstName + '">');
                        var lastName = grandParent.children('td:nth-child(3)').html();
                        grandParent.children('td:nth-child(3)').html("");
                        grandParent.children('td:nth-child(3)').append('<input type="text" class="form-control col-6" value="' + lastName + '">');
                        var address = grandParent.children('td:nth-child(5)').html();
                        grandParent.children('td:nth-child(5)').html("");
                        grandParent.children('td:nth-child(5)').append('<input type="text" class="form-control col-6" value="' + address + '">');
                        var amka = grandParent.children('td:nth-child(6)').html();
                        grandParent.children('td:nth-child(6)').html("");
                        grandParent.children('td:nth-child(6)').append('<input type="text" class="form-control col-6" value="' + amka + '">');
                        var tel = grandParent.children('td:nth-child(7)').html();
                        grandParent.children('td:nth-child(7)').html("");
                        grandParent.children('td:nth-child(7)').append('<input type="text" class="form-control col-6" value="' + tel + '">');
                        var paypalAccount = grandParent.children('td:nth-child(8)').html();
                        grandParent.children('td:nth-child(8)').html("");
                        grandParent.children('td:nth-child(8)').append('<input type="text" class="form-control col-6" value="' + paypalAccount + '">');
                        var id = $(this).data('id');
                        grandParent.children('td:nth-child(9)').children().hide();
                        grandParent.children('td:nth-child(9)').append('<button class="btn btn-success table-button updateBtn" data-id="' + id + '" >Update</button>');
                        grandParent.children('td:nth-child(9)').append('<button class="btn btn-danger table-button cancelUpdateBtn" data-id="' + id + '">Cancel</button>');
                        updateButtonClicked();
                        cancelUpdateButtonClicked()
                    });
                    $('.setActiveBtn').on('click', function () {
                        var id = $(this).data('id');
                        var isActive = $(this).data('is-active');
                        console.log(id);
                        console.log(isActive);
                        $.ajax({
                            url: '@Url.Action("AdminSetUserActiveInactive", "Admin")',
                            type: 'PUT',
                            data: JSON.stringify({ 'userId': id, 'isUserActive': isActive }),
                            contentType: 'application/json; charset=utf-8',
                            success() {
                                ListDoctors('', '', -1);
                            },
                            error: function () {
                                console.log('ERROR!');
                            }
                        });
                    });
                },
                error: function (error) {
                    console.log(error)
                }
            })
        }
        function AddAntiForgeryToken (data) {
            data.__RequestVerificationToken = $('#__AjaxAntiForgeryForm input[name=__RequestVerificationToken]').val();
            return data;
        };
        function cancelUpdateButtonClicked() {
            $('.cancelUpdateBtn').on('click', function (e) {
                var grandParent = $(this).parent().parent();
                var firstName = grandParent.children('td:nth-child(2)').children('input').val();
                var lastName = grandParent.children('td:nth-child(3)').children('input').val();
                var specialty = grandParent.children('td:nth-child(4)').html();
                var address = grandParent.children('td:nth-child(5)').children('input').val();
                var amka = grandParent.children('td:nth-child(6)').children('input').val();
                var tel = grandParent.children('td:nth-child(7)').children('input').val();
                var paypalAccount = grandParent.children('td:nth-child(8)').children('input').val();
                var id = $(this).data('id');
                grandParent.children('td:nth-child(2)').html(firstName);
                grandParent.children('td:nth-child(3)').html(lastName);
                grandParent.children('td:nth-child(5)').html(address);
                grandParent.children('td:nth-child(6)').html(amka);
                grandParent.children('td:nth-child(7)').html(tel);
                grandParent.children('td:nth-child(8)').html(paypalAccount);
                grandParent.children('td:nth-child(9)').children().show();
                grandParent.children('td:nth-child(9)').children('.updateBtn').hide();
                grandParent.children('td:nth-child(9)').children('.cancelUpdateBtn').hide();
            });
        }
        function updateButtonClicked() {
            $('.updateBtn').on('click', function (e) {
                var grandParent = $(this).parent().parent();
                var firstName = grandParent.children('td:nth-child(2)').children('input').val();
                var lastName = grandParent.children('td:nth-child(3)').children('input').val();
                var specialty = grandParent.children('td:nth-child(4)').html();
                var address = grandParent.children('td:nth-child(5)').children('input').val();
                var amka = grandParent.children('td:nth-child(6)').children('input').val();
                var tel = grandParent.children('td:nth-child(7)').children('input').val();
                var paypalAccount = grandParent.children('td:nth-child(8)').children('input').val();
                var id = $(this).data('id');
                var modifiedUser = {
                    User: {
                        Id : id,
                        FirstName : firstName,
                        LastName : lastName,
                        AMKA : amka,
                        PaypalAccount : paypalAccount,
                        PhoneNumber: tel,
                    },
                    Doctor: {
                        MedicalSpecialty: specialty,
                        OfficeAddress: address
                    }
                };
                $.ajax({
                    url: '@Url.Action("UpdateUser", "Admin")',
                    type: 'PUT',
                    data: AddAntiForgeryToken(modifiedUser),
                    success: function (data) {
                        console.log('SUCCESS!');
                        grandParent.children('td:nth-child(2)').html(firstName);
                        grandParent.children('td:nth-child(3)').html(lastName);
                        grandParent.children('td:nth-child(5)').html(address);
                        grandParent.children('td:nth-child(6)').html(amka);
                        grandParent.children('td:nth-child(7)').html(tel);
                        grandParent.children('td:nth-child(8)').html(paypalAccount);
                        grandParent.children('td:nth-child(9)').children().show();
                        grandParent.children('td:nth-child(9)').children('.updateBtn').hide();
                        grandParent.children('td:nth-child(9)').children('.cancelUpdateBtn').hide();
                        alert('User updated successfully!');
                    },
                    error: function (error) {
                        console.log('ERROR!');
                        console.log(error);
                    }
                });
            });
        }
    })


    </script>
}

