@{
    ViewBag.Title = "Insureds";
}
@section cssScripts{
    <link href="@Url.Content("~/Content/TestPlaton.css")" type="text/css" rel="stylesheet" />
    <style>
        body {
            width: 146vw;
        }
    </style>
}

<main id="main" class="offset-2 mt-5">
    <div class="page-header">
        <h1>
            Insureds
        </h1>
    </div>
    <div class="">
        <table class="table mt-4" id="insuredsList">
            <thead>
                <tr>
                    <th scope="col"></th>
                    <th scope="col">First Name</th>
                    <th scope="col">Last Name</th>
                    <th scope="col">Address</th>
                    <th scope="col">Insured Plan</th>
                    <th scope="col">AMKA</th>
                    <th scope="col">Telephon</th>
                    <th scope="col">Paypal Account</th>
                    <th scope="col">Refund Pending</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</main>


@section scripts{
    @Scripts.Render("~/bundles/jqueryval")
    <script>
    $(document).ready(function () {
        ListInsureds('', '');
        var counter = 0;
        function ListInsureds(firstName, lastName) {
            $.ajax({
                dataType: 'json',
                type: 'get',
                url: '/api/Search/SearchInsuredResults?insuredsFirstName=' + firstName + '&insuredsLastName=' + lastName ,
                success: function (data) {
                    $('#insuredsList tbody').empty();
                    data.forEach(function (insured) {
                        $('#insuredsList tbody').append(
                              '<tr><td><img src="@Url.Content("~/Content/img/Insureds/")' + insured.User.Id + '/' + insured.User.ProfilePicture + '" alt="' + insured.User.ProfilePicture + '"' + 'class="rounded-circle">'
                            + '</td><td>' + insured.User.FirstName
                            + '</td><td>' + insured.User.LastName
                            + '</td><td>' + insured.HomeAddress
                            + ((insured.InsuredPlan == null) ? '</td><td>No Plan' : '</td><td>' + insured.InsuredPlan.Name)
                            + '</td><td>' + insured.User.AMKA
                            + '</td><td>' + insured.User.PhoneNumber
                            + '</td><td>' + insured.User.PaypalAccount
                            + '</td><td>' + parseFloat(insured.RefundPending).toFixed(2) + ' &euro;'
                            + '</td>'
                            + '<td><button class="btn btn-success table-button editBtn" data-id="' + insured.UserId + '" >Edit</button>'
                            + ((insured.User.IsActive == true) ? '<button class="btn btn-danger table-button setActiveBtn" data-id="' + insured.UserId + '">Deactivate</button>' : '<button class="btn btn-danger table-button setActiveBtn" data-id="' + insured.UserId + '">Activate</button>')
                            + '<button class="btn btn-primary table-button sentMessageBtn" data-id="' + insured.UserId + '" >Message</button>'
                            + ((insured.InsuredPlan == null || insured.InsuredPlan.Name == 'Gold' || insured.RefundPending == 0) ? '<button class= "btn btn-secondary table-button disabled" data-id="' + insured.User.Id + '">Refund</button></td>' : '<button class= "btn btn-secondary table-button refundBtn" data-id="' + insured.User.Id + '">Refund</button></td>')                        
                            + '</tr>')
                    });
                    $('.editBtn').on('click', function (e) {
                        var grandParent = $(this).parent().parent();
                        var firstName = grandParent.children('td:nth-child(2)').html();
                        grandParent.children('td:nth-child(2)').html("");
                        grandParent.children('td:nth-child(2)').append('<input type="text" value="' + firstName + '">');
                        var lastName = grandParent.children('td:nth-child(3)').html();
                        grandParent.children('td:nth-child(3)').html("");
                        grandParent.children('td:nth-child(3)').append('<input type="text" value="' + lastName + '">');
                        var address = grandParent.children('td:nth-child(5)').html();
                        grandParent.children('td:nth-child(5)').html("");
                        grandParent.children('td:nth-child(5)').append('<input type="text" value="' + address + '">');
                        var amka = grandParent.children('td:nth-child(6)').html();
                        grandParent.children('td:nth-child(6)').html("");
                        grandParent.children('td:nth-child(6)').append('<input type="text" value="' + amka + '">');
                        var tel = grandParent.children('td:nth-child(7)').html();
                        grandParent.children('td:nth-child(7)').html("");
                        grandParent.children('td:nth-child(7)').append('<input type="text" value="' + tel + '">');
                        var paypalAccount = grandParent.children('td:nth-child(8)').html();
                        grandParent.children('td:nth-child(8)').html("");
                        grandParent.children('td:nth-child(8)').append('<input type="text" value="' + paypalAccount + '">');
                        var id = $(this).data('id');
                        grandParent.children('td:nth-child(9)').children().hide();
                        grandParent.children('td:nth-child(9)').append('<button class="btn btn-success updateBtn" data-id="' + id + '" >Update</button>');
                    });                    
                    $('.refundBtn').click(function (e) {
                        const date = new Date();
                        const amountValue = parseFloat($(this).parent().prev().text().split(' ')[0]).toFixed(2);
                        const email = $(this).parent().prev().prev().text().trim();
                        const insuredId = $(e.target).data('id');
                        $.ajax({
                            type: 'get',
                            url: '/Payment/GetAccessToken',
                            dataType: 'json',
                            success: function (data) {                                
                                let payment = new Object();
                                payment.sender_batch_header = new Object();
                                payment.sender_batch_header.sender_batch_id = 'Payouts_' + date;
                                payment.sender_batch_header.email_subject = 'You have a refund!';
                                payment.sender_batch_header.email_message = 'You have received a refund! Thanks for using our service!';
                                payment.items = [];
                                payment.items[0] = new Object();
                                payment.items[0].recipient_type = 'EMAIL';
                                payment.items[0].amount = new Object();
                                payment.items[0].amount.value = amountValue;
                                payment.items[0].amount.currency = 'EUR';
                                payment.items[0].note = 'Thanks for your patronage';
                                payment.items[0].sender_item_id = '' + date.getFullYear() + (date.getMonth() + 1) + date.getDate() + '0001';
                                payment.items[0].receiver = email;
                                $.ajax({
                                    type: 'post',
                                    url: 'https://api.sandbox.paypal.com/v1/payments/payouts',
                                    dataType: 'json',
                                    contentType: 'application/json',
                                    beforeSend: function (xhr) {
                                        xhr.setRequestHeader('Authorization', data);
                                    },
                                    data: JSON.stringify(payment),
                                    processData: false,
                                    success: function (data) {
                                        console.log(data);
                                        console.log(insuredId)
                                        $.ajax({
                                            type: 'put',
                                            url: '/Insureds/SetRefundToZero?insuredId=' + insuredId,
                                            success: function () {
                                                console.log('success');                                                
                                                $(e.target).parent().prev().html(parseFloat('0').toFixed(2) + ' &euro;')
                                            },
                                            error: function () {
                                                console.log('error')
                                            }
                                        })
                                    },
                                    error: function (error) {
                                        console.log(error);
                                    }
                                })
                            },
                            error: function (error) {
                                3
                                console.log(error)
                            }
                        })            
                    })
                },
                error: function (error) {
                    console.log(error)
                }
            })
        }
    })

    </script>
}
