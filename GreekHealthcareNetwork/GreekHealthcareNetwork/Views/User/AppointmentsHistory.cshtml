@model GreekHealthcareNetwork.Models.SearchLoginViewModel
@using Microsoft.AspNet.Identity;
@{
    ViewBag.Title = "Appointments History";
    var CurrentUserId = User.Identity.GetUserId();
}

@section cssScripts{
    <link href="@Url.Content("~/Content/TestPlaton.css")" type="text/css" rel="stylesheet" />
}

<main id="main" class="mt-4">
    <div class="col-8 offset-2">
        <div class="page-header">
            <h1>
                Appointments History
            </h1>
        </div>
        @Html.Partial("_SearchPartial")
        <!-- Appointments -->
        <div>
            <table class="table table-responsive mt-4">
                <thead>
                    <tr>
                        <th scope="col"></th>
                        @if (User.IsInRole("Doctor"))
                        {
                            <th scope="col">Patient</th>
                        }
                        @if (User.IsInRole("Insured"))
                        {
                            <th scope="col">Doctor</th>
                            <th scope="col">Specialty</th>
                        }
                        <th scope="col">Date</th>
                        <th scope="col">Time</th>
                        <th scope="col">Status</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="appointmentsList">
                </tbody>
            </table>
        </div>
    </div>
</main>

<div class="modal fade" id="appointmentDetailsModal" tabindex="-1" role="dialog" aria-labelledby="appointmentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentDetailsModalLabel">Appointment Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    @if (User.IsInRole("Doctor"))
                    {
                        <div class="col">
                            <h4>Patient</h4>
                            <div class="row mt-2">
                                <div id="insuredsPicture" class="col-4">
                                    <img class="rounded-circle" src="">
                                </div>
                                <div class="col-8">
                                    <h5 id="insuredsFirstName"></h5>
                                    <h5 id="insuredsLastName"></h5>
                                    <p id="insuredsAge"></p>
                                </div>
                            </div>
                        </div>
                    }
                    @if (User.IsInRole("Insured"))
                    {
                        <div class="col">
                            <h4>Doctor</h4>
                            <div class="row mt-2">
                                <div id="doctorsPicture" class="col-4">
                                    <img class="rounded-circle" src="">
                                </div>
                                <div class="col-8">
                                    <h5 id="doctorsFirstName"></h5>
                                    <h5 id="doctorsLastName"></h5>
                                    <p id="Specialty"></p>
                                </div>
                            </div>
                        </div>
                    }
                    <div class="col">
                        <h4>Details</h4>
                        <div class="mt-2">
                            <p id="appointmentDateTime"></p>
                            <p id="status"></p>
                        </div>
                    </div>
                </div>
                <div class="row mt-5">
                    <div class="col">
                        <h6>@(User.IsInRole("Insured") ? "Your comments to Doctor:" : "Patient's comments:")</h6>
                        <p id="patientComments"></p>
                        @if (User.IsInRole("Doctor"))
                        {
                            <h6>Your Comments:</h6>
                            <p id="doctorsComments"></p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section AppointmentScripts{
    <script>
        $(document).ready(function () {
            var isUserDoctor = @(User.IsInRole("Doctor") ? "true" : "false");
            var isUserInsured = @(User.IsInRole("Insured") ? "true" : "false");

            console.log('isUserDoctor:' + isUserDoctor);
            console.log('isUserInsured:' + isUserInsured);

            function ListAppointments(firstName, lastName, specialty, appointmentDate, userId) {
                    if (appointmentDate == "") {
                        appointmentDate = "0001-01-01";
                    }
                    $.ajax({
                        dataType: 'json',
                        type: 'get',
                        url: '/api/Search/AppointmentsSearchResults?firstName=' + firstName +
                                                                         '&lastName=' + lastName +
                                                                         '&doctorsSpecialty=' + specialty +
                                                                         '&appointmentDay=' + appointmentDate +
                                                                         '&userId=' + userId,
                        success: function (data) {
                            $('#appointmentsList').empty();
                            console.log('Step1');
                            console.log(data.length);
                            if (data.length == 0) {
                                $("#appointmentsList").append('<tr><td colspan="7">There are no appointments matching these criteria.</td></tr>');
                            }
                            else {
                                console.log('Step2')
                                console.log(data.length);
                                console.log(data)
                                data.forEach(function (appointment) {
                                    console.log('Step3');
                                    const appointmentStart = appointment.AppointmentStartTime.split(":");
                                    const appointmentEnd = appointment.AppointmentEndTime.split(":");
                                    const appointmentDate = appointment.AppointmentDate.split("T");
                                    if (isUserInsured) {
                                        $('#appointmentsList').append('<tr><td>' +
                                            '<img src="@Url.Content("~/Content/img/Doctors/")' + appointment.Doctor.User.Id + '/' + appointment.Doctor.User.ProfilePicture + '" alt="' + appointment.Doctor.User.ProfilePicture + '"' + 'class="rounded-circle"></td>' +
                                            '<td>' + appointment.Doctor.User.FirstName + ' ' + appointment.Doctor.User.LastName + '</td>' +
                                            '<td>' + appointment.Doctor.MedicalSpecialty + '</td>' +
                                            '<td>' + appointmentDate[0] + '</td>' +
                                            '<td>' + appointmentStart[0] + ':' + appointmentStart[1] + '-' + appointmentEnd[0] + ':' + appointmentEnd[1] + '</td>' +
                                            '<td>' + appointment.AppointmentStatus + '</td>' +
                                            ((appointment.AppointmentStatus == "Upcoming") ? '<td><button type="button" class="btn btn-success" data-toggle="modal" data-target="">Edit</button><button class="btn btn-danger">Cancel</button>' : '<td><button type="button" class="btn btn-light showAppointmentDetails" data-id="' + appointment.Id + '">View</button>') +
                                            '</td ></tr>'
                                        );
                                    }
                                    if (isUserDoctor) {
                                        $('#appointmentsList').append('<tr><td>' +
                                            '<img src="@Url.Content("~/Content/img/Insureds/")' + appointment.Insured.User.Id + '/' + appointment.Insured.User.ProfilePicture + '" alt="' + appointment.Doctor.User.ProfilePicture + '"' + 'class="rounded-circle"></td>' +
                                            '<td>' + appointment.Insured.User.FirstName + ' ' + appointment.Insured.User.LastName + '</td>' +
                                            '<td>' + appointmentDate[0] + '</td>' +
                                            '<td>' + appointmentStart[0] + ':' + appointmentStart[1] + ' - ' + appointmentEnd[0] + ':' + appointmentEnd[1] + '</td>' +
                                            '<td>' + appointment.AppointmentStatus + '</td>' +
                                            ((appointment.AppointmentStatus == "Upcoming") ? '<td><button type="button" class="btn btn-success" data-toggle="modal" data-target="">Edit</button><button class="btn btn-danger">Cancel</button>' : '<td><button type="button" class="btn btn-light showAppointmentDetails" data-id="' + appointment.Id + '">View</button>') +
                                            '</td ></tr>'
                                    );

                                    }
                                });
                            }
                            fixFooterPosition(data.length);
                            $('.showAppointmentDetails').click(function (e) {
                                console.log('view button clicked');
                                let id = $(e.target).data('id');
                                console.log('id is:' + id)
                                $.ajax({
                                    url: '/api/Search/SearchAppointmentById/' + id,
                                    type: 'get',
                                    dataType: 'json',
                                    success: function (appointment) {
                                        console.log('Into modal')
                                        const appointmentStart = appointment.AppointmentStartTime.split(":");
                                        const appointmentEnd = appointment.AppointmentEndTime.split(":");
                                        const appointmentDate = appointment.AppointmentDate.split("T");

                                        if (isUserInsured) {
                                            $('#doctorsPicture img').attr('src', '@Url.Content("~/Content/img/Doctors/")' + appointment.Doctor.User.Id + '/' + appointment.Doctor.User.ProfilePicture);
                                            $('#doctorsFirstName').text(appointment.Doctor.User.FirstName);
                                            $('#doctorsLastName').text(appointment.Doctor.User.LastName);

                                            $('#Specialty').text(appointment.Doctor.MedicalSpecialty);
                                            $('#appointmentDateTime').text(appointmentDate[0] + ' ' + appointmentStart[0] + ':' + appointmentStart[1] + ' - ' + appointmentEnd[0] + ':' + appointmentEnd[1]);
                                            $('#status').text('Status: ' + appointment.AppointmentStatus);
                                            $('#patientComments').text(appointment.InsuredComments);
                                            $('#appointmentDetailsModal').modal('show');
                                        }

                                        if (isUserDoctor) {
                                            const dOB = appointment.Insured.User.DoB.split("T");
                                            $('#insuredsPicture img').attr('src', '@Url.Content("~/Content/img/Insureds/")' + appointment.Insured.User.Id + '/' + appointment.Insured.User.ProfilePicture);
                                            $('#insuredsFirstName').text(appointment.Insured.User.FirstName);
                                            $('#insuredsLastName').text(appointment.Insured.User.LastName);

                                            $('#Specialty').text(dOB[0]);
                                            $('#appointmentDateTime').text(appointmentDate[0] + ' ' + appointmentStart[0] + ':' + appointmentStart[1] + ' - ' + appointmentEnd[0] + ':' + appointmentEnd[1]);
                                            $('#status').text('Status: ' + appointment.AppointmentStatus);
                                            $('#patientComments').text(appointment.InsuredComments);
                                            $('#doctorComments').text(appointment.DoctorComments);
                                            $('#appointmentDetailsModal').modal('show');
                                        }

                                    },
                                    error: function () {
                                        console.log('error')
                                    }
                                })
                            });
                        },
                        error: function (error) {
                            console.log(error);
                            $('#appointmentsList').empty();
                            $("#appointmentsList").append('<tr><td colspan="7"> Something went wrong. Please try again later. </td></tr>')
                        }
                    })
            }
            
            console.log('@CurrentUserId');

            ListAppointments('', '', -1, '0001-01-01', '@CurrentUserId');

            $('#search').on('submit', function (e) {
                e.preventDefault();
                if (isUserInsured) {
                    ListAppointments(e.target[0].value, e.target[1].value, e.target[2].value, e.target[3].value, '@CurrentUserId');
                }
                if (isUserDoctor) {
                    ListAppointments(e.target[0].value, e.target[1].value, -1, e.target[2].value, '@CurrentUserId');
                }
            })
        })
    </script>
}

@*@section AppointmentScripts{
    <script>
        $(document).ready(function () {
            var isUserDoctor = @(User.IsInRole("Doctor") ? "true" : "false");
            var isUserInsured = @(User.IsInRole("Insured") ? "true" : "false");

            console.log('isUserDoctor:' + isUserDoctor);
            console.log('isUserInsured:' + isUserInsured);

            if (isUserInsured) {
                function ListInsuredAppointments(firstName, lastName, specialty, appointmentDate, userId) {
                    if (appointmentDate == "") {
                        appointmentDate = "0001-01-01";
                    }
                    $.ajax({
                        dataType: 'json',
                        type: 'get',
                        url: '/api/Search/InsuredAppointmentsSearchResults?doctorsFirstName=' + firstName +
                            '&doctorsLastName=' + lastName +
                            '&doctorsSpecialty=' + specialty +
                            '&appointmentDay=' + appointmentDate +
                            '&userId=' + userId,
                        success: function (data) {
                            $('#appointmentsList').empty();
                            console.log('Step1');
                            console.log(data.length);
                            if (data.length == 0) {
                                $("#appointmentsList").append('<tr><td colspan="7">There are no appointments matching these criteria.</td></tr>');
                            }
                            else {
                                console.log('Step2')
                                console.log(data.length);
                                console.log(data)
                                data.forEach(function (appointment) {
                                    console.log('Step3');
                                    const appointmentStart = appointment.AppointmentStartTime.split(":");
                                    const appointmentEnd = appointment.AppointmentEndTime.split(":");
                                    const appointmentDate = appointment.AppointmentDate.split("T");
                                    $('#appointmentsList').append('<tr><td>' +
                                        '<img src="@Url.Content("~/Content/img/Doctors/")' + appointment.Doctor.User.Id + '/' + appointment.Doctor.User.ProfilePicture + '" alt="' + appointment.Doctor.User.ProfilePicture + '"' + 'class="rounded-circle"></td>' +
                                        '<td>' + appointment.Doctor.User.FirstName + ' ' + appointment.Doctor.User.LastName + '</td>' +
                                        '<td>' + appointment.Doctor.MedicalSpecialty + '</td>' +
                                        '<td>' + appointmentDate[0] + '</td>' +
                                        '<td>' + appointmentStart[0] + ':' + appointmentStart[1] + '-' + appointmentEnd[0] + ':' + appointmentEnd[1] + '</td>' +
                                        '<td>' + appointment.AppointmentStatus + '</td>' +
                                        ((appointment.AppointmentStatus == "Upcoming") ? '<td><button type="button" class="btn btn-success" data-toggle="modal" data-target="">Edit</button><button class="btn btn-danger">Cancel</button>' : '<td><button type="button" class="btn btn-light showAppointmentDetails" data-id="' + appointment.Id + '">View</button>') +
                                        '</td ></tr>'
                                    );
                                });
                            }
                            fixFooterPosition(data.length);
                            $('.showAppointmentDetails').click(function (e) {
                                console.log('view button clicked');
                                let id = $(e.target).data('id');
                                console.log('id is:' + id)
                                $.ajax({
                                    url: '/api/Search/SearchAppointmentById/' + id,
                                    type: 'get',
                                    dataType: 'json',
                                    success: function (appointment) {
                                        console.log('Into modal')
                                        const appointmentStart = appointment.AppointmentStartTime.split(":");
                                        const appointmentEnd = appointment.AppointmentEndTime.split(":");
                                        const appointmentDate = appointment.AppointmentDate.split("T");
                                        $('#doctorsPicture img').attr('src', '@Url.Content("~/Content/img/Doctors/")' + appointment.Doctor.User.Id + '/' + appointment.Doctor.User.ProfilePicture);
                                        $('#doctorsFirstName').text(appointment.Doctor.User.FirstName);
                                        $('#doctorsLastName').text(appointment.Doctor.User.LastName);

                                        $('#Specialty').text(appointment.Doctor.MedicalSpecialty);
                                        $('#appointmentDateTime').text(appointmentDate[0] + ' ' + appointmentStart[0] + ':' + appointmentStart[1] + ' - ' + appointmentEnd[0] + ':' + appointmentEnd[1]);
                                        $('#status').text('Status: ' + appointment.AppointmentStatus);
                                        $('#patientComments').text(appointment.InsuredComments);
                                        $('#appointmentDetailsModal').modal('show');
                                    },
                                    error: function () {
                                        console.log('error')
                                    }
                                })
                            });
                        },
                        error: function (error) {
                            console.log(error);
                            $('#appointmentsList').empty();
                            $("#appointmentsList").append('<tr><td colspan="7"> Something went wrong. Please try again later. </td></tr>')
                        }
                    })
                }
            }
            if (isUserDoctor) {
                function ListDoctorAppointments(insuredFirstName, insuredLastName, appointmentDate, doctorId) {
                    if (appointmentDate == "") {
                        appointmentDate = "0001-01-01";
                    }

                    console.log('insuredFirstName: ' + insuredFirstName);
                    console.log('insuredLastName: ' + insuredLastName);
                    console.log('AppointmentDate: ' + appointmentDate);
                    console.log('doctorId: ' + doctorId);

                    $.ajax({
                        dataType: 'json',
                        type: 'get',
                        url: '/api/Search/DoctorAppointmentsSearchResults?insuredsFirstName=' + insuredFirstName +
                            '&insuredsLastName=' + insuredLastName +
                            '&appointmentDate=' + appointmentDate +
                            '&userId=' + doctorId,
                        success: function (data) {
                            $('#appointmentList').empty();
                            if (data.length == 0) {
                                $("#appointmentsList").append('<tr><td colspan="7">There are no appointments matching these criteria.</td></tr>');
                            }
                            else {
                                data.forEach(function (appointment) {
                                    const appointmentStart = appointment.AppointmentStartTime.split(":");
                                    const appointmentEnd = appointment.AppointmentEndTime.split(":");
                                    const appointmentDate = appointment.AppointmentDate.split("T");
                                    $('#appointmentsList').append('<tr><td>' +
                                        '<img src="@Url.Content("~/Content/img/Insureds/")' + appointment.Insured.User.Id + '/' + appointment.Insured.User.ProfilePicture + '" alt="' + appointment.Doctor.User.ProfilePicture + '"' + 'class="rounded-circle"></td>' +
                                        '<td>' + appointment.Insured.User.FirstName + ' ' + appointment.Insured.User.LastName + '</td>' +
                                        '<td>' + appointmentDate[0] + '</td>' +
                                        '<td>' + appointmentStart[0] + ':' + appointmentStart[1] + ' - ' + appointmentEnd[0] + ':' + appointmentEnd[1] + '</td>' +
                                        '<td>' + appointment.AppointmentStatus + '</td>' +
                                        ((appointment.AppointmentStatus == "Upcoming") ? '<td><button type="button" class="btn btn-success" data-toggle="modal" data-target="">Edit</button><button class="btn btn-danger">Cancel</button>' : '<td><button type="button" class="btn btn-light showAppointmentDetails" data-id="' + appointment.Id + '">View</button>') +
                                        '</td ></tr>'
                                    );
                                });
                            }
                        },
                        error: function (error) {
                            console.log(error);
                            $('#appointmentList').empty();
                            $("#appointmentsList").append('<tr><td colspan="7"> Something went wrong. Please try again later. </td></tr>')
                        }
                    })
                }

            }
            console.log('@CurrentUserId');
            if (isUserInsured) {
                ListInsuredAppointments('', '', -1, '0001-01-01', '@CurrentUserId');
            }
            if (isUserDoctor) {
                ListDoctorAppointments('', '', '0001-01-01', '@CurrentUserId');
            }
            $('#search').on('submit', function (e) {
                e.preventDefault();
                if (isUserInsured) {
                    ListInsuredAppointments(e.target[0].value, e.target[1].value, e.target[2].value, e.target[3].value, '@CurrentUserId');
                }
                if (isUserDoctor) {
                    ListDoctorAppointments(e.target[0].value, e.target[1].value, e.target[3].value, '@CurrentUserId');
                }
            })
        })
    </script>
}*@


